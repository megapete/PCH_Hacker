//
//  PCH_Exploit.c
//  PCH_Hacker
//
//  Created by PeterCoolAssHuber on 2018-09-07.
//  Copyright Â© 2018 Peter Huber. All rights reserved.
//

#include "PCH_Exploit.h"
#include <string.h>

// built-in function to use with exploit files
bool ExploitFunction(void *inData, void *outData)
{
    PCH_ExploitInputData *inputData = inData;
    PCH_ExploitOutputData *returnData = outData;
    
    int portToOpen = inputData->port;
    
    PCH_ListNode *nextPortNode = inputData->url->ports->currentHead;
    while (nextPortNode != NULL)
    {
        PCH_Port *nextPort = nextPortNode->data;
        
        if (nextPort->number == portToOpen)
        {
            nextPort->status = portOpenReadWrite;
            
            sprintf(returnData->returnString, "Successfully opened port %d on URL: %s", portToOpen, inputData->url->name);
            
            return true;
        }
        
        nextPortNode = nextPortNode->next;
    }
    
    return false;
}

PCH_Exploit CreateExploit(char *name, int port, int size)
{
    PCH_Exploit newExploit;
    
    strncpy(newExploit.name, name, MAX_FILE_NAME_LENGTH);
    newExploit.exploitPortNum = port;
    newExploit.fileSize = size;
    newExploit.execFuncPtr = &ExploitFunction;
    
    return newExploit;
}

/// Function called to run the exploit on a given URL
bool RunExploit(PCH_Exploit *exploit, PCH_Url *url, char *returnBuff, size_t returnBuffSize)
{
    PCH_ExploitInputData inData;
    PCH_ExploitOutputData outData;
    
    inData.port = exploit->exploitPortNum;
    inData.url = url;
    
    bool result = exploit->execFuncPtr(&inData, &outData);
    
    if (result)
    {
        strncpy(returnBuff, outData.returnString, returnBuffSize);
    }
    else
    {
        returnBuff[0] = '\0';
    }
    
    return result;
}
